---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getSEOMetadata, getStructuredData } from '../utils/seo';
import { SITE_CONFIG } from '../utils/constants';
import '../styles/global.css';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
  canonical?: string;
  publishedTime?: string;
  modifiedTime?: string;
  author?: string;
  tags?: string[];
  noindex?: boolean;
}

const {
  title,
  description,
  image,
  type = 'website',
  canonical,
  publishedTime,
  modifiedTime,
  author,
  tags,
  noindex = false,
} = Astro.props;

const seo = getSEOMetadata({
  title,
  description,
  image,
  type,
  canonical: canonical || Astro.url.pathname,
  publishedTime,
  modifiedTime,
  author,
  tags,
});

const structuredData = getStructuredData('Organization');
const currentUrl = new URL(Astro.url.pathname, SITE_CONFIG.url).href;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="canonical" href={currentUrl} />
    <link rel="preconnect" href="https://formspree.io" />
    <link rel="preconnect" href="https://remotive.com" crossorigin />

    <!-- SEO Meta Tags -->
    <title>{seo.title}</title>
    <meta name="description" content={seo.description} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Open Graph -->
    <meta property="og:title" content={seo.openGraph.title} />
    <meta property="og:description" content={seo.openGraph.description} />
    <meta property="og:url" content={seo.openGraph.url} />
    <meta property="og:site_name" content={seo.openGraph.siteName} />
    <meta property="og:type" content={seo.openGraph.type} />
    <meta property="og:image" content={seo.openGraph.images[0].url} />
    <meta property="og:image:width" content={String(seo.openGraph.images[0].width)} />
    <meta property="og:image:height" content={String(seo.openGraph.images[0].height)} />
    {seo.openGraph.publishedTime && (
      <meta property="article:published_time" content={seo.openGraph.publishedTime} />
    )}
    {seo.openGraph.modifiedTime && (
      <meta property="article:modified_time" content={seo.openGraph.modifiedTime} />
    )}

    <!-- Twitter Card -->
    <meta name="twitter:card" content={seo.twitter.card} />
    <meta name="twitter:title" content={seo.twitter.title} />
    <meta name="twitter:description" content={seo.twitter.description} />
    <meta name="twitter:image" content={seo.twitter.image} />

    <!-- Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

    <!-- Analytics Scripts -->
    {import.meta.env.PUBLIC_PLAUSIBLE_URL && (
      <script
        defer
        data-domain={import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN || 'corpnce.com'}
        src={`${import.meta.env.PUBLIC_PLAUSIBLE_URL}/js/script.js`}
      />
    )}

    {import.meta.env.PUBLIC_POSTHOG_URL && import.meta.env.PUBLIC_POSTHOG_KEY && (
      <script>
        !(function (t, e) {
          var o, n, p, r;
          e.__SV ||
            ((window.posthog = e),
            (e._i = []),
            (e.init = function (i, s, a) {
              function g(t, e) {
                var o = e.split('.');
                2 == o.length && ((t = t[o[0]]), (e = o[1])),
                  (t[e] = function () {
                    t.push([e].concat(Array.prototype.slice.call(arguments, 0)));
                  });
              }
              ((p = t.createElement('script')).type = 'text/javascript'),
                (p.async = !0),
                (p.src = s.api_host + '/static/array.js'),
                (r = t.getElementsByTagName('script')[0]).parentNode.insertBefore(p, r);
              var u = e;
              for (
                void 0 !== a ? (u = e[a] = []) : (a = 'posthog'),
                  u.people = u.people || [],
                  u.toString = function (t) {
                    var e = 'posthog';
                    return 'posthog' !== a && (e += '.' + a), t || (e += ' (stub)'), e;
                  },
                  u.people.toString = function () {
                    return u.toString(1) + '.people (stub)';
                  },
                  o = 'capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId'.split(
                    ' '
                  ),
                  n = 0;
                n < o.length;
                n++
              )
                g(u, o[n]);
              e._i.push([i, s, a]);
            }),
            (e.__SV = 1));
        })(document, window.posthog || []);
        posthog.init('{import.meta.env.PUBLIC_POSTHOG_KEY}', {
          api_host: '{import.meta.env.PUBLIC_POSTHOG_URL}',
          loaded: function (posthog) {
            if (import.meta.env.DEV) console.log('PostHog loaded');
          },
        });
      </script>
    )}

    <!-- Analytics Utilities -->
    <script is:inline>
      // Analytics utilities
      function trackPageView(url) {
        if (typeof window === 'undefined') return;
        if (window.plausible) {
          window.plausible('pageview', { u: url });
        }
      }

      function trackEvent(event) {
        if (typeof window === 'undefined') return;
        if (window.posthog) {
          window.posthog.capture(event.name, event.props);
        }
      }

      function trackCTAClick(ctaName, location) {
        trackEvent({
          name: 'cta_click',
          props: {
            cta_name: ctaName,
            location: location,
          },
        });
      }

      function trackFormSubmit(formName, formType) {
        trackEvent({
          name: 'form_submit',
          props: {
            form_name: formName,
            form_type: formType,
          },
        });
      }

      function trackScrollDepth(depth) {
        trackEvent({
          name: 'scroll_depth',
          props: {
            depth: `${depth}%`,
          },
        });
      }

      // Make functions available globally
      window.trackCTAClick = trackCTAClick;
      window.trackFormSubmit = trackFormSubmit;
      window.trackEvent = trackEvent;

      // Track page view on load
      document.addEventListener('DOMContentLoaded', () => {
        trackPageView(window.location.pathname);

        // Track scroll depth
        let maxScroll = 0;
        window.addEventListener('scroll', () => {
          const scrollPercent = Math.round(
            ((window.scrollY + window.innerHeight) / document.documentElement.scrollHeight) * 100
          );
          if (scrollPercent > maxScroll && scrollPercent % 25 === 0) {
            maxScroll = scrollPercent;
            trackScrollDepth(scrollPercent);
          }
        });
      });
    </script>
  </head>
  <body>
    <Header />
    <main>
      <slot />
    </main>
    <Footer />
  </body>
</html>
